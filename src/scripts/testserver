#!/usr/bin/env python
"""
This is a deejayd test server executable
"""

import sys, os

from twisted.internet import reactor
from twisted.python import log

from deejayd.ui.config import DeejaydConfig
from deejayd.net.deejaydProtocol import DeejaydFactory
from deejayd.core import DeejayDaemonCore

# argv[1] should be port
# argv[2] should be music dir
# argv[3] should be video dir
# argv[4] should be db filename
if len(sys.argv) != 5:
    sys.exit('Incorrect invocation')

port = sys.argv[1]
music_dir = sys.argv[2]
video_dir = sys.argv[3]
dbfilename = sys.argv[4]

log.startLogging(open('/tmp/testdeejayd.log', 'a'))

config = DeejaydConfig()
config.set('net', 'port', port)
config.set('mediadb', 'music_directory', music_dir)
config.set('mediadb', 'video_directory', video_dir)
config.set('database', 'db_file', dbfilename)
config.set('general', 'video_support', 'yes')
config.set('general', 'media_backend', 'xine')
config.set('xine','audio_output',"none")
config.set('xine','video_output',"none")

# start core
deejayd_core = DeejayDaemonCore(config)
deejayd_core.update_audio_library(sync = True, objanswer = False)
deejayd_core.update_video_library(sync = True, objanswer = False)

factory = DeejaydFactory(deejayd_core)
reactor.listenTCP(int(port), factory)

def printReady():
    os.write(2, 'ready\n')

reactor.addSystemEventTrigger('after', 'startup', printReady)
reactor.run()

# vim: ts=4 sw=4 expandtab
